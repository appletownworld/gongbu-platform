name: Deploy to VPS

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ GitHub UI
  push:               # ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –≤–∫–ª—é—á–µ–Ω!
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # –î–µ–ø–ª–æ–π –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ–¥–∞–∫—à–Ω –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd /var/www/gongbu-platform || (sudo git clone https://github.com/appletownworld/gongbu-platform.git /var/www/gongbu-platform && cd /var/www/gongbu-platform)
          sudo git pull origin main
          
          # –°–æ–∑–¥–∞–Ω–∏–µ .env –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ GitHub
          sudo tee .env << 'EOF'
          NODE_ENV=production
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}
          WEBAPP_URL=${{ secrets.APP_URL }}
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          EOF
          
          # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          sudo docker-compose -f docker-compose.prod.yml down || true
          
          # –û—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
          sudo docker system prune -f
          sudo docker-compose -f docker-compose.prod.yml build --no-cache
          
          # –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–∏—Å—Ç–µ–º—ã
          sudo docker-compose -f docker-compose.prod.yml up -d
          
          # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
          for i in {1..60}; do
            if sudo docker-compose -f docker-compose.prod.yml ps | grep -q "Up (healthy)"; then
              echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞ –∏ –∑–¥–æ—Ä–æ–≤–∞"; break
            fi
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ health checks ($i/60)..."
            sleep 3
          done
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
          echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
          sudo docker-compose -f docker-compose.prod.yml ps

    - name: Wait for HTTPS (smart retry)
      run: |
        echo "üîç –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ HTTPS endpoint..."
        APP_URL="${{ secrets.APP_URL }}"
        DOMAIN_URL="${APP_URL:-https://gongbu.appletownworld.com}"
        
        curl -fsS "$DOMAIN_URL/health" \
          --retry 20 --retry-all-errors --retry-delay 5 --max-time 10 \
          --retry-connrefused || {
          echo "‚ùå HTTPS health check –Ω–µ —É–¥–∞–ª—Å—è, –ø—Ä–æ–±—É–µ–º HTTP..."
          HTTP_URL=$(echo "$DOMAIN_URL" | sed 's/https:/http:/')
          curl -fsS "$HTTP_URL/health" \
            --retry 10 --retry-all-errors --retry-delay 3 --max-time 8
        }

    - name: Notify Telegram
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üöÄ Deploy Status: ${{ job.status }}
          üì¶ Repository: gongbu-platform
          üåê Environment: Production
          üîó URL: ${{ secrets.API_BASE_URL }}