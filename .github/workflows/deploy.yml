name: Deploy to VPS

on:
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· GitHub UI
  push:               # âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½!
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² Ð´Ð¾Ð¼Ð°ÑˆÐ½ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ð‘Ð•Ð— SUDO!)
          cd ~/gongbu-platform || (git clone https://github.com/appletownworld/gongbu-platform.git ~/gongbu-platform && cd ~/gongbu-platform)
          
          # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ (Ñ€ÐµÑˆÐ°ÐµÑ‚ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ñ‹)
          git fetch origin
          git reset --hard origin/main
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² GitHub
          cat > .env << 'EOF'
          NODE_ENV=production
          PORT=3000
          
          # Database
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # Redis
          REDIS_URL=redis://localhost:6379
          REDIS_PASSWORD=
          
          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=7d
          
          # Telegram
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}
          TELEGRAM_WEBAPP_SECRET=${{ secrets.TELEGRAM_WEBAPP_SECRET }}
          WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}
          ADMIN_USER_IDS=${{ secrets.ADMIN_USER_IDS }}
          TELEGRAM_PAYMENT_TOKEN=
          
          # URLs
          WEBAPP_URL=${{ secrets.APP_URL }}
          APP_URL=${{ secrets.APP_URL }}
          API_BASE_URL=${{ secrets.API_BASE_URL }}
          WEBSOCKET_URL=wss://${{ secrets.DOMAIN_NAME }}/ws
          DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
          
          # CORS
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
          
          # Payment
          STRIPE_SECRET_KEY=
          STRIPE_WEBHOOK_SECRET=
          
          # Email
          SENDGRID_API_KEY=
          EMAIL_FROM=noreply@${{ secrets.DOMAIN_NAME }}
          
          # Monitoring
          GRAFANA_ADMIN_PASSWORD=admin
          
          # Services URLs (internal)
          AUTH_SERVICE_URL=http://auth-service:3001
          COURSE_SERVICE_URL=http://course-service:3002
          BOT_SERVICE_URL=http://bot-service:3003
          PAYMENT_SERVICE_URL=http://payment-service:3004
          NOTIFICATION_SERVICE_URL=http://notification-service:3005
          ANALYTICS_SERVICE_URL=http://analytics-service:3006
          EOF
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² docker Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ (ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½)
          groups $USER | grep -q docker || (echo "âš ï¸ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ðµ docker. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ: sudo usermod -aG docker $USER && exit")
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð³Ð¾ nginx.conf
          cat > nginx.conf << 'EOF'
          events {
              worker_connections 1024;
          }
          
          http {
              upstream web-app {
                  server web-app:3000;
              }
              
              upstream bot-service {
                  server bot-service:3003;
              }
              
              server {
                  listen 80;
                  server_name _;
                  
                  location /health {
                      return 200 'OK';
                      add_header Content-Type text/plain;
                  }
                  
                  location /api/bots {
                      proxy_pass http://bot-service;
                      proxy_set_header Host $host;
                      proxy_set_header X-Real-IP $remote_addr;
                  }
                  
                  location /webhook {
                      proxy_pass http://bot-service;
                      proxy_set_header Host $host;
                      proxy_set_header X-Real-IP $remote_addr;
                  }
                  
                  location / {
                      proxy_pass http://web-app;
                      proxy_set_header Host $host;
                      proxy_set_header X-Real-IP $remote_addr;
                  }
              }
          }
          EOF
          
          # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          docker-compose -f docker-compose.simple.yml down || true
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Docker
          docker system prune -f || echo "âš ï¸ Docker system prune failed, continuing..."
          
          # Ð—Ð°Ð¿ÑƒÑÐº ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹)
          docker-compose -f docker-compose.simple.yml up -d --build
          
          # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
          echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
          for i in {1..30}; do
            if docker-compose -f docker-compose.simple.yml ps | grep -q "Up"; then
              echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹"
              break
            fi
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² ($i/30)..."
            sleep 5
          done
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
          echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²:"
          docker-compose -f docker-compose.simple.yml ps
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð² Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
          if ! docker-compose -f docker-compose.simple.yml ps | grep -q "Up"; then
            echo "âŒ Ð•ÑÑ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°Ð¼Ð¸. Ð›Ð¾Ð³Ð¸:"
            docker-compose -f docker-compose.simple.yml logs --tail=50
          fi

    - name: Wait for HTTPS (smart retry)
      run: |
        echo "ðŸ” ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ HTTPS endpoint..."
        APP_URL="${{ secrets.APP_URL }}"
        DOMAIN_URL="${APP_URL:-https://gongbu.appletownworld.com}"
        
        curl -fsS "$DOMAIN_URL/health" \
          --retry 20 --retry-all-errors --retry-delay 5 --max-time 10 \
          --retry-connrefused || {
          echo "âŒ HTTPS health check Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ HTTP..."
          HTTP_URL=$(echo "$DOMAIN_URL" | sed 's/https:/http:/')
          curl -fsS "$HTTP_URL/health" \
            --retry 10 --retry-all-errors --retry-delay 3 --max-time 8
        }

    - name: Notify Telegram
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ðŸš€ Deploy Status: ${{ job.status }}
          ðŸ“¦ Repository: gongbu-platform
          ðŸŒ Environment: Production
          ðŸ”— URL: ${{ secrets.API_BASE_URL }}