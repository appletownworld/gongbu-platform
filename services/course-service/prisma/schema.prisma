generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Course management models
model Course {
  id                String            @id @default(uuid())
  title             String
  slug              String            @unique
  description       String?
  shortDescription  String?
  coverImageUrl     String?
  thumbnailUrl      String?
  
  // Course content
  category          CourseCategory
  difficulty        CourseDifficulty  @default(BEGINNER)
  language          String            @default("ru")
  estimatedDuration Int?              // in minutes
  
  // Pricing and access
  price             Decimal?          @db.Decimal(10, 2)
  currency          String            @default("USD")
  isPremium         Boolean           @default(false)
  isPublished       Boolean           @default(false)
  publishedAt       DateTime?
  
  // SEO and tags
  tags              String[]
  metaTitle         String?
  metaDescription   String?
  
  // Creator info
  creatorId         String
  collaboratorIds   String[]          @default([])
  
  // Course structure
  lessons           Lesson[]
  assignments       Assignment[]
  modules           CourseModule[]
  
  // Student interactions
  enrollments       Enrollment[]
  reviews           CourseReview[]
  certificates      CourseCertificate[]
  comments          CourseComment[]
  likes             CourseLike[]
  
  // File attachments
  files             File[]
  
  // Analytics
  viewCount         Int               @default(0)
  enrollmentCount   Int               @default(0)
  completionCount   Int               @default(0)
  certificateCount  Int               @default(0)
  averageRating     Decimal?          @db.Decimal(3, 2)
  
  // Course settings
  settings          Json              @default("{}")
  
  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?
  
  @@map("courses")
}

model CourseModule {
  id          String     @id @default(uuid())
  title       String
  description String?
  order       Int
  
  courseId    String
  course      Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  lessons     Lesson[]
  assignments Assignment[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@unique([courseId, order])
  @@map("course_modules")
}

model Lesson {
  id               String            @id @default(uuid())
  title            String
  slug             String
  content          String            // Rich text content
  contentType      LessonContentType @default(TEXT)
  
  // Lesson media
  videoUrl         String?
  audioUrl         String?
  attachments      Json              @default("[]") // Array of file objects
  
  // Lesson structure
  order            Int
  duration         Int?              // in minutes
  
  // Relations
  courseId         String
  course           Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  moduleId         String?
  module           CourseModule?     @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  
  // Prerequisites
  prerequisiteIds  String[]          @default([])
  
  // Student interactions
  progress         LessonProgress[]
  assignments      Assignment[]
  comments         LessonComment[]
  
  // File attachments
  files            File[]
  
  // Settings
  isPreview        Boolean           @default(false)
  isPublished      Boolean           @default(false)
  isFree           Boolean           @default(false)
  settings         Json              @default("{}")
  
  // Timestamps
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  
  @@unique([courseId, slug])
  @@unique([courseId, order])
  @@map("lessons")
}

model Assignment {
  id             String               @id @default(uuid())
  title          String
  description    String
  instructions   String
  
  // Assignment type and content
  type           AssignmentType
  content        Json                 // Assignment-specific data
  
  // Grading
  maxScore       Int                  @default(100)
  passingScore   Int                  @default(60)
  
  // Timing
  timeLimit      Int?                 // in minutes
  dueDate        DateTime?
  
  // Relations
  courseId       String
  course         Course               @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  moduleId       String?
  module         CourseModule?        @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  
  lessonId       String?
  lesson         Lesson?              @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  
  // Student submissions
  submissions    AssignmentSubmission[]
  
  // File attachments
  files          File[]
  
  // Order and settings
  order          Int
  isPublished    Boolean              @default(false)
  settings       Json                 @default("{}")
  
  // Timestamps
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  deletedAt      DateTime?
  
  @@unique([courseId, order])
  @@map("assignments")
}

model Enrollment {
  id              String             @id @default(uuid())
  studentId       String             // User ID from auth service
  
  courseId        String
  course          Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Enrollment status
  status          EnrollmentStatus   @default(ACTIVE)
  enrolledAt      DateTime           @default(now())
  completedAt     DateTime?
  
  // Progress tracking
  progress        StudentProgress[]
  lessonProgress  LessonProgress[]
  submissions     AssignmentSubmission[]
  reviews         CourseReview[]
  certificate     CourseCertificate?
  
  // Payment info
  paymentId       String?            // Payment transaction ID
  discountCode    String?
  paidAmount      Decimal?           @db.Decimal(10, 2)
  
  // Settings
  settings        Json               @default("{}")
  
  // Timestamps
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  @@unique([studentId, courseId])
  @@map("enrollments")
}

model StudentProgress {
  id             String       @id @default(uuid())
  studentId      String       // User ID from auth service
  
  courseId       String
  enrollmentId   String
  enrollment     Enrollment   @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  // Progress metrics
  completedLessons    Int         @default(0)
  totalLessons        Int         @default(0)
  completedAssignments Int        @default(0)
  totalAssignments    Int         @default(0)
  
  progressPercentage  Decimal     @default(0) @db.Decimal(5, 2)
  
  // Time tracking
  timeSpent          Int         @default(0) // in minutes
  lastAccessedAt     DateTime?
  
  // Performance
  averageScore       Decimal?    @db.Decimal(5, 2)
  
  // Additional fields for compatibility
  status             String      @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, DROPPED
  totalTimeSpent     Int         @default(0) // in minutes
  certificateIssued  Boolean     @default(false)
  
  // Timestamps
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  
  @@unique([studentId, courseId], name: "userId_courseId")
  @@map("student_progress")
}

model LessonProgress {
  id            String         @id @default(uuid())
  studentId     String         // User ID from auth service
  
  lessonId      String
  lesson        Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  enrollmentId  String
  enrollment    Enrollment     @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  // Progress status
  status        LessonStatus   @default(NOT_STARTED)
  progressPercentage Decimal   @default(0) @db.Decimal(5, 2)
  completed     Boolean        @default(false)
  
  // Time tracking
  startedAt     DateTime?
  completedAt   DateTime?
  timeSpent     Int           @default(0) // in minutes
  
  // Video/audio progress
  watchTime     Int           @default(0) // in seconds
  
  // Additional progress fields
  score         Decimal?      @db.Decimal(5, 2)
  lastAccessedAt DateTime?
  
  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@unique([studentId, lessonId], name: "userId_lessonId")
  @@map("lesson_progress")
}

model AssignmentSubmission {
  id            String            @id @default(uuid())
  studentId     String            // User ID from auth service
  
  assignmentId  String
  assignment    Assignment        @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  
  enrollmentId  String
  enrollment    Enrollment        @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  // Submission content
  content       Json              // Student's answers/work
  attachments   Json              @default("[]") // Uploaded files
  
  // Grading
  status        SubmissionStatus  @default(PENDING)
  score         Decimal?          @db.Decimal(5, 2)
  maxScore      Int
  
  // Feedback
  feedback      String?
  gradedBy      String?           // Grader user ID
  gradedAt      DateTime?
  
  // Timing
  submittedAt   DateTime          @default(now())
  attemptNumber Int               @default(1)
  
  // Timestamps
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  @@unique([studentId, assignmentId, attemptNumber])
  @@map("assignment_submissions")
}

model CourseReview {
  id            String      @id @default(uuid())
  userId        String      // User ID from auth service
  
  courseId      String
  course        Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  enrollmentId  String
  enrollment    Enrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  // Review content
  rating        Int         // 1-5 stars
  title         String?
  comment       String?
  
  // Detailed ratings
  contentRating     Int?    // 1-5 stars for content quality
  instructorRating  Int?    // 1-5 stars for instructor
  difficultyRating  Int?    // 1-5 stars for difficulty level
  valueRating       Int?    // 1-5 stars for value for money
  
  // Social features
  helpfulVotes      Int     @default(0) // Number of helpful votes
  totalVotes        Int     @default(0) // Total votes (helpful + not helpful)
  isVerified        Boolean @default(false)
  isPublic          Boolean @default(true)
  
  // Moderation
  isModerated       Boolean @default(false)
  moderatedBy       String? // Moderator user ID
  moderatedAt       DateTime?
  moderationReason  String?
  
  // Comments on review
  comments          ReviewComment[]
  votes             ReviewVote[]
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@unique([userId, courseId])
  @@map("course_reviews")
}

model ReviewComment {
  id            String      @id @default(uuid())
  reviewId      String
  review        CourseReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  
  userId        String      // User ID from auth service
  parentId      String?     // For nested comments
  
  content       String
  isPublic      Boolean     @default(true)
  
  // Social features
  helpfulVotes  Int         @default(0)
  totalVotes    Int         @default(0)
  
  // Moderation
  isModerated   Boolean     @default(false)
  moderatedBy   String?
  moderatedAt   DateTime?
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("review_comments")
}

model CourseComment {
  id            String      @id @default(uuid())
  courseId      String
  course        Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  userId        String      // User ID from auth service
  parentId      String?     // For nested comments
  
  content       String
  isPublic      Boolean     @default(true)
  
  // Social features
  helpfulVotes  Int         @default(0)
  totalVotes    Int         @default(0)
  likes         Int         @default(0)
  
  // Moderation
  isModerated   Boolean     @default(false)
  moderatedBy   String?
  moderatedAt   DateTime?
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("course_comments")
}

model LessonComment {
  id            String      @id @default(uuid())
  lessonId      String
  lesson        Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  userId        String      // User ID from auth service
  parentId      String?     // For nested comments
  
  content       String
  isPublic      Boolean     @default(true)
  
  // Social features
  helpfulVotes  Int         @default(0)
  totalVotes    Int         @default(0)
  likes         Int         @default(0)
  
  // Moderation
  isModerated   Boolean     @default(false)
  moderatedBy   String?
  moderatedAt   DateTime?
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("lesson_comments")
}

model UserFollow {
  id            String      @id @default(uuid())
  followerId    String      // User ID who follows
  followingId   String      // User ID being followed
  
  // Timestamps
  createdAt     DateTime    @default(now())
  
  @@unique([followerId, followingId])
  @@map("user_follows")
}

model CourseLike {
  id            String      @id @default(uuid())
  userId        String      // User ID from auth service
  courseId      String
  course        Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt     DateTime    @default(now())
  
  @@unique([userId, courseId])
  @@map("course_likes")
}

model ReviewVote {
  id            String      @id @default(uuid())
  userId        String      // User ID from auth service
  reviewId      String
  review        CourseReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  
  isHelpful     Boolean     // true = helpful, false = not helpful
  
  // Timestamps
  createdAt     DateTime    @default(now())
  
  @@unique([userId, reviewId])
  @@map("review_votes")
}

model CourseCertificate {
  id            String      @id @default(uuid())
  userId        String      // User ID from auth service
  
  courseId      String
  course        Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  enrollmentId  String      @unique
  enrollment    Enrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  // Certificate details
  certificateId String      @unique // Public certificate ID
  certificateNumber String  @unique // Certificate number
  issueDate     DateTime    @default(now())
  expiryDate    DateTime?
  
  // Content
  title         String
  description   String?
  skills        String[]    @default([])
  
  // Status
  status        String      @default("ACTIVE") // ACTIVE, REVOKED, EXPIRED
  isPublic      Boolean     @default(true)
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@unique([userId, courseId])
  @@map("course_certificates")
}

// Enums
enum CourseCategory {
  PROGRAMMING
  DESIGN
  BUSINESS
  MARKETING
  LANGUAGE
  SCIENCE
  ARTS
  HEALTH
  LIFESTYLE
  OTHER
}

enum CourseDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum LessonContentType {
  TEXT
  VIDEO
  AUDIO
  INTERACTIVE
  QUIZ
  DOCUMENT
  MIXED
}

enum AssignmentType {
  QUIZ
  ESSAY
  CODE
  PROJECT
  UPLOAD
  PEER_REVIEW
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  SUSPENDED
  REFUNDED
  DROPPED
  PAUSED
}

enum LessonStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  GRADED
  NEEDS_REVISION
  APPROVED
}

model File {
  id                 String            @id @default(cuid())
  filename           String            // Sanitized filename used for storage  
  originalFilename   String            @map("original_filename") // Original filename from upload
  mimeType           String            @map("mime_type") // MIME type of the file
  size               Int               // File size in bytes
  path               String            // Relative path to file on disk/cloud
  url                String            // Public URL for accessing the file
  context            FileUploadContext // Upload context: course-cover, lesson-video, etc.
  isPublic           Boolean           @default(false) @map("is_public") // Whether file is publicly accessible
  userId             String            @map("user_id") // ID of user who uploaded the file
  
  // Associated entities (nullable)
  courseId           String?           @map("course_id")
  lessonId           String?           @map("lesson_id")
  assignmentId       String?           @map("assignment_id")
  
  // File processing status
  status             FileStatus        @default(UPLOADED)
  processedUrl       String?           @map("processed_url") // URL to processed version (e.g., compressed video)
  thumbnailUrl       String?           @map("thumbnail_url") // URL to thumbnail/preview image
  metadata           Json              @default("{}") // Additional file metadata (dimensions, duration, etc.)
  
  // Timestamps
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  deletedAt          DateTime?         @map("deleted_at")
  
  // Relations (optional - when we have user management)
  course             Course?           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson             Lesson?           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  assignment         Assignment?       @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([userId])
  @@index([context])
  @@index([courseId])
  @@index([lessonId])
  @@index([assignmentId])
  @@index([status])
  @@index([createdAt])
  @@index([isPublic])
  @@index([userId, context])
  @@index([courseId, context])
  
  @@map("files")
}

enum FileUploadContext {
  COURSE_COVER      @map("course-cover")
  COURSE_THUMBNAIL  @map("course-thumbnail")
  LESSON_VIDEO      @map("lesson-video")
  LESSON_AUDIO      @map("lesson-audio")
  LESSON_ATTACHMENT @map("lesson-attachment")
  ASSIGNMENT_SUBMISSION @map("assignment-submission")
  USER_AVATAR       @map("user-avatar")
  TEMP              @map("temp")
}

enum FileStatus {
  UPLOADED    // File uploaded successfully
  PROCESSING  // File is being processed (e.g., video compression)
  READY       // File processed and ready for use
  FAILED      // Processing failed
  DELETED     // File marked for deletion
}
